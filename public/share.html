<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PaseoLibros – Lista compartida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f6;
      color: #222;
    }
    .page {
      max-width: 720px;
      margin: 0 auto;
      padding: 1rem 1.25rem 2rem;
    }
    h1 {
      margin: 0.5rem 0 0.25rem;
      font-size: 1.5rem;
    }
    .owner {
      margin: 0;
      color: #555;
      font-size: 0.95rem;
    }
    .status {
      margin: 0.75rem 0 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    .list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .item {
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 0.75rem 0.85rem;
      margin-bottom: 0.75rem;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }
    .cover {
      width: 48px;
      height: 72px;
      border-radius: 0.25rem;
      object-fit: cover;
      background: #ddd;
      flex-shrink: 0;
    }
    .placeholder {
      width: 48px;
      height: 72px;
      border-radius: 0.25rem;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #555;
      flex-shrink: 0;
    }
    .item-main {
      flex: 1;
      min-width: 0;
    }
    .item-title {
      font-weight: 600;
      margin: 0 0 0.25rem;
      font-size: 0.98rem;
    }
    .item-meta {
      margin: 0;
      font-size: 0.85rem;
      color: #555;
    }
    .pill {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: #eef;
      color: #334;
      font-size: 0.75rem;
      margin-right: 0.35rem;
      margin-top: 0.15rem;
    }
    .pill-secondary {
      background: #eee;
      color: #444;
    }
    @media (max-width: 480px) {
      .item {
        padding: 0.7rem 0.75rem;
      }
      .item-title {
        font-size: 0.94rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1 id="share-title">Lista compartida</h1>
    <p id="share-owner" class="owner"></p>
    <p id="share-status" class="status">Cargando lista…</p>
    <ul id="share-list" class="list"></ul>
  </div>

  <script>
    (function () {
      // === Config API: mismo backend en PC y móvil ===
      var isLocalhost = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');
      // En desarrollo, backend local; en producción (Render), mismo host
      var API_BASE = isLocalhost ? 'http://localhost:3011' : '';

      function getTokenFromUrl() {
        try {
          var url = new URL(window.location.href);

          // 1) ?t=xxxxx (share.html?t=TOKEN)
          var t = url.searchParams.get('t');
          if (t) return t;

          // 2) /share/TOKEN (por si usas ruta "bonita")
          var parts = url.pathname.split('/').filter(Boolean);
          var last = parts[parts.length - 1] || '';
          // Evita confundir "share" o "share.html" con token
          if (last && last !== 'share' && last !== 'share.html') {
            return last;
          }
        } catch (e) {
          console.error('Error analizando URL', e);
        }
        return null;
      }

      function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      var token = getTokenFromUrl();
      var titleEl = document.getElementById('share-title');
      var ownerEl = document.getElementById('share-owner');
      var statusEl = document.getElementById('share-status');
      var listEl = document.getElementById('share-list');

      if (!token) {
        if (statusEl) statusEl.textContent = 'Enlace no válido (falta token).';
        return;
      }

      // Petición al backend: /api/share/:token
      fetch(API_BASE + '/api/share/' + encodeURIComponent(token))
        .then(function (res) {
          return res.json().then(function (data) {
            return { ok: res.ok, data: data };
          });
        })
        .then(function (result) {
          var ok = result.ok;
          var data = result.data || {};

          if (!ok) {
            if (statusEl) statusEl.textContent = data.error || 'Error al cargar la lista compartida.';
            return;
          }

          var tipo = data.tipo || '';
          var owner = data.owner_name || '';
          var items = Array.isArray(data.items) ? data.items : [];

          if (titleEl) {
            titleEl.textContent = tipo === 'deseos'
              ? 'Lista de deseos compartida'
              : 'Ejemplares compartidos';
          }

          if (ownerEl) {
            ownerEl.textContent = owner
              ? 'De ' + owner
              : '';
          }

          if (!items.length) {
            if (statusEl) statusEl.textContent = 'La lista está vacía.';
            return;
          }

          if (statusEl) statusEl.textContent = 'Total: ' + items.length;

          listEl.innerHTML = items.map(function (item) {
            var titulo = escapeHtml(item.titulo || '—');
            var autores = escapeHtml(item.autores || '');
            var isbn = escapeHtml(item.isbn || '');
            var estado = escapeHtml(item.estado || '');
            var ubicacion = escapeHtml(item.ubicacion || '');
            var urlPortada = item.url_portada || '';
            var tipoTexto = escapeHtml(item.tipo || '');

            var coverHtml;
            if (urlPortada) {
              var src = urlPortada;
              // Si tu backend guarda rutas relativas tipo "/uploads/xyz.jpg"
              if (urlPortada.charAt(0) === '/') {
                src = API_BASE + urlPortada;
              }
              coverHtml = '<img class="cover" src="' + src + '" alt="Portada" />';
            } else {
              coverHtml = '<div class="placeholder">Sin<br>portada</div>';
            }

            var metaLine = '';

            if (autores) metaLine += autores;
            if (isbn) {
              if (metaLine) metaLine += ' · ';
              metaLine += 'ISBN: ' + isbn;
            }
            if (estado) {
              if (metaLine) metaLine += ' · ';
              metaLine += estado;
            }
            if (ubicacion) {
              if (metaLine) metaLine += ' · ';
              metaLine += ubicacion;
            }

            // Para deseos, mostramos tipo/ubicación como "pills"
            var pills = '';
            if (tipo === 'deseos') {
              if (tipoTexto) pills += '<span class="pill">' + tipoTexto + '</span>';
              if (ubicacion) pills += '<span class="pill pill-secondary">' + ubicacion + '</span>';
            }

            return (
              '<li class="item">' +
                coverHtml +
                '<div class="item-main">' +
                  '<p class="item-title">' + titulo + '</p>' +
                  (pills ? ('<p class="item-meta">' + pills + '</p>') : '') +
                  (metaLine ? ('<p class="item-meta">' + metaLine + '</p>') : '') +
                '</div>' +
              '</li>'
            );
          }).join('');
        })
        .catch(function (err) {
          console.error(err);
          if (statusEl) statusEl.textContent = 'Error de red al cargar la lista compartida.';
        });
    })();
  </script>
</body>
</html>

