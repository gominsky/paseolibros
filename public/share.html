<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PaseoLibros Â· Lista compartida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuentes (igual que la app) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
</head>

<body class="share-page">
  <div class="app">
    <header class="app-header">
      <div class="logo header-center">
        <div class="logo-icon">
          <span class="logo-mark">Pdl</span>
        </div>
        <div class="logo-text">
          <h1>Lista compartida</h1>
          <p id="share-subtitle">Solo lectura</p>
        </div>
      </div>

      <div class="header-right">
        <a href="./" class="btn btn-ghost btn-sm" style="text-decoration:none;">Volver</a>
        <button id="btn-copy-link" class="btn btn-secondary btn-sm" type="button">Copiar enlace</button>
      </div>
    </header>

    <main class="app-main">
      <div class="column column-right">
        <div class="card">
          <div class="card-header-inline">
            <h2 id="share-title">Cargandoâ€¦</h2>
            <div class="card-header-actions">
              <span class="share-chip" id="share-badge">Solo lectura</span>
            </div>
          </div>

          <p id="share-info" class="helper-text">Estamos cargando la listaâ€¦</p>

          <div id="share-table-wrap" class="table-wrapper" style="display:none;">
            <!-- MISMO ESTILO que tabla principal: class="table" -->
            <table id="share-table" class="table">
              <thead id="share-thead"></thead>
              <tbody id="share-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const token = qs.get('t') || '';

  const elTitle = document.getElementById('share-title');
  const elInfo = document.getElementById('share-info');
  const elSubtitle = document.getElementById('share-subtitle');

  const elWrap = document.getElementById('share-table-wrap');
  const elThead = document.getElementById('share-thead');
  const elTbody = document.getElementById('share-tbody');

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Igual que el front: aceptamos absolutas y relativas
  function urlPortadaAbsoluta(url){
    if (!url) return '';
    if (/^https?:\/\//i.test(url)) return url;
    return url;
  }

  function renderTabla(headers, rowsHtml){
    elThead.innerHTML = `<tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr>`;
    elTbody.innerHTML = rowsHtml.join('');
    elWrap.style.display = 'block';
  }

  function cellPortada(portadaUrl){
    const portada = urlPortadaAbsoluta(portadaUrl);
    if (portada){
      return `<img class="portada-mini-img" src="${esc(portada)}" alt="Portada" loading="lazy">`;
    }
    return `<div class="portada-placeholder-mini" aria-hidden="true">ðŸ“š</div>`;
  }

  function renderDeseos(items){
    const rows = (items || []).map(d => {
      const titulo = d.titulo || d.nombre || 'â€”';
      const autores = d.autores || d.autor || '';
      const tipo = d.tipo || '';
      const ubic = d.ubicacion || '';
      const portada = d.url_portada || d.portada_url || '';

      return `
        <tr>
          <td>${cellPortada(portada)}</td>
          <td><strong>${esc(titulo)}</strong></td>
          <td>${esc(autores)}</td>
          <td>${esc(tipo)}</td>
          <td>${esc(ubic)}</td>
        </tr>
      `;
    });

    renderTabla(['Portada', 'TÃ­tulo', 'Autor', 'Tipo', 'UbicaciÃ³n'], rows);
    elSubtitle.textContent = 'Lista de deseos Â· Solo lectura';
  }

  function renderEjemplares(items){
    const rows = (items || []).map(e => {
      const titulo = e.titulo || 'â€”';
      const autores = e.autores || '';
      const isbn = e.isbn || '';
      const estado = e.estado || '';
      const ubic = e.ubicacion || '';
      const portada = e.url_portada || e.portada_url || '';

      return `
        <tr>
          <td>${cellPortada(portada)}</td>
          <td><strong>${esc(titulo)}</strong></td>
          <td>${esc(autores)}</td>
          <td>${esc(isbn)}</td>
          <td>${esc(estado)}</td>
          <td>${esc(ubic)}</td>
        </tr>
      `;
    });

    renderTabla(['Portada', 'TÃ­tulo', 'Autor/es', 'ISBN', 'Estado', 'UbicaciÃ³n'], rows);
    elSubtitle.textContent = 'Ejemplares Â· Solo lectura';
  }

  async function load(){
    if (!token){
      elTitle.textContent = 'Enlace incompleto';
      elInfo.textContent = 'Falta el token en la URL. Ejemplo: share.html?t=TU_TOKEN';
      return;
    }

    try{
      const res = await fetch(`/api/share/${encodeURIComponent(token)}`, { method: 'GET' });
      const data = await res.json().catch(() => ({}));

      if (!res.ok){
        elTitle.textContent = 'Enlace no vÃ¡lido';
        elInfo.textContent = data.error || 'No se pudo cargar la lista compartida.';
        return;
      }

      const tipo = data.tipo || data.type || '';
      const owner = data.owner || data.propietario || data.usuario || null;
      const ownerName = owner?.nombre_usuario || owner?.nombre || data.owner_name || '';

      if (tipo === 'deseos' || tipo === 'wishlist'){
        elTitle.textContent = ownerName ? `Deseos de ${ownerName}` : 'Lista de deseos';
        elInfo.textContent = (data.items?.length ?? data.deseos?.length ?? 0) ? '' : 'No hay deseos en esta lista.';
        renderDeseos(data.items || data.deseos || data.wishlist || []);
      } else {
        elTitle.textContent = ownerName ? `Ejemplares de ${ownerName}` : 'Ejemplares';
        elInfo.textContent = (data.items?.length ?? data.ejemplares?.length ?? 0) ? '' : 'No hay ejemplares en esta lista.';
        renderEjemplares(data.items || data.ejemplares || []);
      }
    }catch(e){
      console.error(e);
      elTitle.textContent = 'Error de red';
      elInfo.textContent = 'No se pudo conectar con el servidor.';
    }
  }

  document.getElementById('btn-copy-link')?.addEventListener('click', async () => {
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      const btn = document.getElementById('btn-copy-link');
      const old = btn.textContent;
      btn.textContent = 'Copiado âœ…';
      setTimeout(() => btn.textContent = old, 1200);
    }catch{
      prompt('Copia este enlace:', url);
    }
  });

  load();
})();
</script>
</body>
</html>
