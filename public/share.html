<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PaseoLibros ¬∑ Lista compartida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuentes (igual que la app) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9.144,600;9.144,800&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Peque√±os ajustes para esta p√°gina */
    .share-page .app-header{ grid-template-columns: 1fr auto 1fr; }
    .share-page .header-left{ justify-self: start; }
    .share-page .header-right{ justify-self: end; gap: 10px; }

    .share-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: .9rem;
      opacity: .95;
    }

    .share-content{
      margin-top: 18px;
      display: grid;
      gap: 14px;
    }

    .share-card{
      background: #000;
      border: 1.5px solid rgba(232,170,196,.55);
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .share-card .card-header-inline{
      padding: 14px 14px 10px;
    }
    .share-card .card-body{
      padding: 0 14px 14px;
    }

    /* Reutilizamos estilos de deseos/ejemplares cuando nos convenga */
    .share-list{
      display:grid;
      gap: 10px;
      padding: 0;
      margin: 0;
      list-style: none;
    }
    .share-item{
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      display:grid;
      gap:6px;
    }
    .share-title{ font-weight: 800; }
    .share-meta{ font-size: .9rem; opacity: .9; display:flex; gap:10px; flex-wrap: wrap; }

    .share-grid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    .share-grid .ej-grid-item{ cursor: default; }

    .muted{ opacity: .82; }

    @media (max-width: 820px){
      .share-page .app-header{
        grid-template-columns: 1fr;
        grid-template-areas:
          "actions"
          "title";
      }
      .share-page .header-right{ justify-self: end; }
      .share-page .logo.header-center{ text-align:center; }
      .share-grid{ grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
    /* ===== Share: m√°s ancho en horizontal ===== */
.share-page .app{
  max-width: 1400px !important;           /* sube el techo */
  width: calc(100vw - 24px) !important;   /* casi a borde */
  margin: 12px auto !important;
}

.share-page .app-main{
  padding-left: 0 !important;
  padding-right: 0 !important;
}

.share-page .share-content{
  margin-top: 12px !important;
  padding: 0 12px !important;
}

/* la ‚Äúcard‚Äù que contiene la tabla a ancho completo */
.share-page .share-card{
  width: 100% !important;
}

/* tabla m√°s agradable en ancho */
#share-table-wrap{ overflow-x: auto; }
#share-table{ width: 100%; }
#share-table th, #share-table td{ white-space: nowrap; }
#share-table td.col-title{ white-space: normal; min-width: 340px; }

  </style>
</head>
<body class="share-page">
  <div class="app">
    <header class="app-header">
      <div class="logo header-center">
        <div class="logo-icon">
          <span class="logo-mark">Pdl</span>
        </div>
        <div class="logo-text">
          <h1>Lista compartida</h1>
          <p id="share-subtitle">Solo lectura</p>
        </div>
      </div>

      <div class="header-right">
        <a href="./" class="btn btn-ghost btn-sm" style="text-decoration:none;">Volver</a>
        <button id="btn-copy-link" class="btn btn-secondary btn-sm" type="button">Copiar enlace</button>
      </div>
      
    </header>

    <main class="app-main">
      <div class="share-content">
        <div class="share-card">
          <div class="card-header-inline">
            <h2 id="share-title">Cargando‚Ä¶</h2>
            <div class="card-header-actions">
              <span class="share-chip" id="share-badge">Solo lectura</span>
            </div>
          </div>
          <div class="card-body">
            <p id="share-info" class="helper-text">Estamos cargando la lista‚Ä¶</p>

            <!-- Deseos (lista) -->
            <div id="share-table-wrap" class="table-wrapper" style="display:none;">
              <table id="share-table" class="table-small">
                <thead id="share-thead"></thead>
                <tbody id="share-tbody"></tbody>
              </table>
            </div>
            
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const token = qs.get('t') || '';

  const elTitle = document.getElementById('share-title');
  const elInfo = document.getElementById('share-info');
  const elWishlist = document.getElementById('share-wishlist');
  const elEj = document.getElementById('share-ejemplares');
  const elSubtitle = document.getElementById('share-subtitle');

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function urlPortadaAbsoluta(url){
    if (!url) return '';
    if (/^https?:\/\//i.test(url)) return url;
    return url; // asumimos que el backend sirve rutas absolutas o relativas correctas
  }

  const elWrap = document.getElementById('share-table-wrap');
const elThead = document.getElementById('share-thead');
const elTbody = document.getElementById('share-tbody');

function renderTabla(headers, rowsHtml){
  elThead.innerHTML = `<tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr>`;
  elTbody.innerHTML = rowsHtml.join('');
  elWrap.style.display = 'block';
}
function renderDeseos(items){
  const rows = (items || []).map(d => {
    const titulo = d.titulo || d.nombre || '‚Äî';
    const autores = d.autores || d.autor || '';
    const tipo = d.tipo || '';
    const ubic = d.ubicacion || '';
    const portada = urlPortadaAbsoluta(d.url_portada || d.portada_url || '');

    return `
      <tr>
        <td>${portada
          ? `<img class="share-cover" src="${esc(portada)}" alt="Portada" loading="lazy">`
          : `<div class="share-cover-ph" aria-hidden="true">üìö</div>`
        }</td>
        <td class="col-title"><strong>${esc(titulo)}</strong></td>
        <td>${esc(autores)}</td>
        <td>${esc(tipo)}</td>
        <td>${esc(ubic)}</td>
      </tr>
    `;
  });

  renderTabla(['', 'T√≠tulo', 'Autor', 'Tipo', 'Ubicaci√≥n'], rows);
  elSubtitle.textContent = 'Lista de deseos ¬∑ Solo lectura';
}

function renderEjemplares(items){
  const rows = (items || []).map(e => {
    const titulo = e.titulo || '‚Äî';
    const autores = e.autores || '';
    const estado = e.estado || '';
    const ubic = e.ubicacion || '';
    const isbn = e.isbn || '';
    const portada = urlPortadaAbsoluta(e.url_portada || e.portada_url || '');

    return `
      <tr>
        <td>${portada
          ? `<img class="share-cover" src="${esc(portada)}" alt="Portada" loading="lazy">`
          : `<div class="share-cover-ph" aria-hidden="true">üìö</div>`
        }</td>
        <td class="col-title"><strong>${esc(titulo)}</strong></td>
        <td>${esc(autores)}</td>
        <td>${esc(isbn)}</td>
        <td>${esc(estado)}</td>
        <td>${esc(ubic)}</td>
      </tr>
    `;
  });

  renderTabla(['', 'T√≠tulo', 'Autor', 'ISBN', 'Estado', 'Ubicaci√≥n'], rows);
  elSubtitle.textContent = 'Ejemplares ¬∑ Solo lectura';
}

  async function load(){
    if (!token){
      elTitle.textContent = 'Enlace incompleto';
      elInfo.textContent = 'Falta el token en la URL. Ejemplo: share.html?t=TU_TOKEN';
      return;
    }

    try{
      const res = await fetch(`/api/share/${encodeURIComponent(token)}`, { method: 'GET' });
      const data = await res.json().catch(() => ({}));

      if (!res.ok){
        elTitle.textContent = 'Enlace no v√°lido';
        elInfo.textContent = data.error || 'No se pudo cargar la lista compartida.';
        return;
      }

      const tipo = data.tipo || data.type || '';
      const owner = data.owner || data.propietario || data.usuario || null;
      const ownerName = owner?.nombre_usuario || owner?.nombre || data.owner_name || '';

      if (tipo === 'deseos' || tipo === 'wishlist'){
        elTitle.textContent = ownerName ? `Deseos de ${ownerName}` : 'Lista de deseos';
        elInfo.textContent = (data.items?.length ?? data.deseos?.length ?? 0) ? '' : 'No hay deseos en esta lista.';
        renderDeseos(data.items || data.deseos || data.wishlist || []);
      } else {
        elTitle.textContent = ownerName ? `Ejemplares de ${ownerName}` : 'Ejemplares';
        elInfo.textContent = (data.items?.length ?? data.ejemplares?.length ?? 0) ? '' : 'No hay ejemplares en esta lista.';
        renderEjemplares(data.items || data.ejemplares || []);
      }
    }catch(e){
      console.error(e);
      elTitle.textContent = 'Error de red';
      elInfo.textContent = 'No se pudo conectar con el servidor.';
    }
  }

  document.getElementById('btn-copy-link')?.addEventListener('click', async () => {
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      const btn = document.getElementById('btn-copy-link');
      const old = btn.textContent;
      btn.textContent = 'Copiado ‚úÖ';
      setTimeout(() => btn.textContent = old, 1200);
    }catch{
      prompt('Copia este enlace:', url);
    }
  });

  load();
})();
</script>
</body>
</html>
